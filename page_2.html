<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂãæÁî¨ÈÆëÊ∞èÂÆóË≠úÊïò - Preface to the Bao Clan Genealogy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Songti SC", "Noto Serif CJK SC", "Source Han Serif SC", serif;
            background: #f5f0e6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 10px;
            padding: 8px 0;
        }

        header h1 {
            font-size: 1.3em;
            color: #8b4513;
            white-space: nowrap;
        }

        header p {
            font-size: 0.85em;
            color: #666;
        }

        .preview-note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #856404;
        }

        .vertical-slider {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            gap: 4px;
        }

        .vertical-slider .slider-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 0.75em;
            color: #666;
            letter-spacing: 1px;
        }

        .vertical-slider input[type="range"] {
            writing-mode: vertical-lr;
            direction: rtl;
            height: 120px;
            width: 20px;
            cursor: pointer;
        }

        .main-content {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .document-area {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .document-container {
            position: relative;
            background: #fffef9;
            border: 2px solid #8b4513;
            border-radius: 8px;
            overflow: hidden;
            width: 700px;
            height: 600px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .original-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
            z-index: 1;
        }

        .document {
            position: absolute;
            top: 0;
            left: 0;
            width: 700px;
            height: 600px;
            z-index: 2;
            pointer-events: none;
            transform-origin: top left;
        }

        .column {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            margin: 0;
            pointer-events: auto;
        }

        .column.title-column .char {
            font-size: 14px;
            font-weight: bold;
        }

        .char {
            font-size: 14px;
            line-height: 1.06;
            cursor: pointer;
            padding: 0.5px 1px;
            border-radius: 2px;
            transition: all 0.15s ease;
            display: block;
            color: rgba(45, 30, 20, var(--text-opacity, 1));
            background: rgba(255, 254, 249, var(--text-bg-opacity, 0.9));
            position: relative;
        }

        .char:hover {
            transform: scale(1.1);
        }

        .char.char-highlight {
            outline: 2px solid #e74c3c;
            outline-offset: 0px;
            z-index: 10;
        }

        .char.locked {
            background: rgba(180, 140, 0, 0.15) !important;
        }

        .phrase-highlight-box {
            position: absolute;
            border: 2px solid #3498db;
            border-radius: 4px;
            pointer-events: none;
            z-index: 101;
        }

        .section-highlight-box {
            position: absolute;
            border: 2px solid rgba(39, 174, 96, 0.7);
            border-radius: 6px;
            pointer-events: none;
            z-index: 100;
        }

        .info-panel {
            width: 380px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .char-info-box {
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 10px;
            background: #fdf2f2;
            position: relative;
        }

        .lock-icon {
            position: absolute;
            bottom: 6px;
            right: 6px;
            font-size: 14px;
            cursor: pointer;
            opacity: 0.7;
            display: none;
        }

        .lock-icon:hover {
            opacity: 1;
        }

        .character-display {
            font-size: 48px;
            text-align: center;
            padding: 4px;
            background: #fff;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .pinyin {
            font-size: 1em;
            color: #8b4513;
            text-align: center;
            margin-bottom: 4px;
        }

        .char-meaning {
            font-size: 0.85em;
            line-height: 1.3;
            color: #333;
            text-align: center;
        }

        .char-context {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
            font-style: italic;
            line-height: 1.3;
            text-align: center;
        }

        .phrase-info-box {
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 10px;
            background: #f0f7fd;
            min-height: 160px;
        }

        .phrase-chinese {
            font-size: 1.2em;
            text-align: center;
            padding: 4px;
            background: #fff;
            border-radius: 4px;
            margin-bottom: 6px;
            letter-spacing: 2px;
        }

        .phrase-translation {
            font-size: 0.9em;
            line-height: 1.35;
            color: #333;
            margin-bottom: 6px;
        }

        .phrase-notes {
            font-size: 0.8em;
            color: #555;
            line-height: 1.3;
        }

        .section-info-box {
            border: 2px solid #27ae60;
            border-radius: 8px;
            padding: 10px;
            background: #f0fdf4;
            min-height: 120px;
        }

        .section-title {
            font-size: 1em;
            font-weight: bold;
            color: #1e8449;
            margin-bottom: 2px;
        }

        .section-chinese {
            font-size: 0.9em;
            color: #27ae60;
            margin-bottom: 4px;
        }

        .section-description {
            font-size: 0.8em;
            line-height: 1.3;
            color: #333;
        }

        @media (max-width: 1000px) {
            .main-content {
                flex-direction: column;
            }

            .info-panel {
                width: 100%;
                position: static;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ÂãæÁî¨ÈÆëÊ∞èÂÆóË≠úÊïò</h1>
            <p>Preface to the Bao Clan Genealogy of Gouyu ‚Äî From Volume 6</p>
        </header>

        <div class="preview-note">
            <strong>Preview:</strong> This is a preliminary transcription showing only the title and first two columns.
            We may want to obtain higher-quality source images before completing the full translation and annotation.
            Hover over characters to see translations; click to lock the display.
        </div>

        <div class="main-content">
            <div class="document-area">
                <div class="document-container" id="documentContainer">
                    <img src="original_2.png" alt="Original document" class="original-image" id="originalImage">
                    <div class="document" id="document">
                        <!-- Content generated by JavaScript -->
                    </div>
                </div>
                <div class="vertical-slider">
                    <span class="slider-label">Transcribed</span>
                    <input type="range" id="overlaySlider" min="0" max="100" value="0">
                    <span class="slider-label">Original</span>
                </div>
            </div>

            <div class="info-panel" id="info-panel">
                <div class="char-info-box" id="charBox">
                    <div class="character-display" id="charDisplay">Êïò</div>
                    <div class="pinyin" id="pinyin">x√π</div>
                    <div class="char-meaning" id="charMeaning">Preface; to narrate, describe</div>
                    <div class="char-context" id="charContext">The title of this document - a preface explaining the genealogy's origins.</div>
                    <span class="lock-icon" id="lockIcon" title="Click to unlock">üîí</span>
                </div>

                <div class="phrase-info-box" id="phraseBox">
                    <div class="phrase-chinese" id="phraseChinese">Êïò</div>
                    <div class="phrase-translation" id="phraseTranslation">"Preface"</div>
                    <div class="phrase-notes" id="phraseNotes">Êïò (x√π) means "preface" or "introduction." This document provides historical context for the Bao clan genealogy, explaining when and why it was compiled.</div>
                </div>

                <div class="section-info-box" id="sectionBox">
                    <div class="section-title" id="sectionTitle">Document Title</div>
                    <div class="section-chinese" id="sectionChinese">Ê®ôÈ°å</div>
                    <div class="section-description" id="sectionDesc">The title indicates this is a preface (Êïò) to the genealogy, providing historical background on how the Bao clan records came to be compiled.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== DOCUMENT DATA STRUCTURE ==========

        const sections = {
            title: {
                name: 'Document Title',
                chinese: 'Ê®ôÈ°å',
                description: 'The title indicates this is a preface (Êïò) to the genealogy, providing historical background on how the Bao clan records came to be compiled.'
            },
            ancestry: {
                name: 'Genealogy Origins',
                chinese: 'Ë≠úÁâíÊ∫êÊµÅ',
                description: 'This section traces the history of the Bao clan genealogy: its origins in the Qianlong period, the initial compilation by ancestor Chongxian, and subsequent efforts to expand and verify the records.'
            }
        };

        const phrases = [
            // TITLE
            { section: 'title', chars: 'Êïò', translation: 'Preface', notes: 'Êïò (x√π) means "preface" or "introduction." This document provides historical context for the Bao clan genealogy, explaining when and why it was compiled.' },

            // ANCESTRY - Column 1
            { section: 'ancestry', chars: 'ÂãæÁî¨ÈÆëÊ∞è‰πãÊúâË≠ú', translation: 'The Bao clan of Gouyu having a genealogy...', notes: 'ÂãæÁî¨ (G≈çuy«íng) is an ancient name for the Ningbo region. ÈÆëÊ∞è is the Bao clan. ‰πãÊúâË≠ú uses classical grammar: "as for [their] having a genealogy..."' },
            { section: 'ancestry', chars: 'ÂßãÊñºÂâçÊ∏Ö‰πæÈöÜÂπ¥', translation: 'began in the Qianlong reign of the former Qing', notes: 'ÂßãÊñº means "began at/in." ÂâçÊ∏Ö (former Qing) indicates this was written after 1911. ‰πæÈöÜ was Emperor Qianlong (r. 1735-1796), one of China\'s longest-reigning emperors.' },
            { section: 'ancestry', chars: 'Â≠£ÂçÅ‰∏ñÁ•ñÂ¥áË≥¢ÂÖ¨', translation: 'when our 10th-generation ancestor, the honorable Chongxian', notes: 'Â≠£ here likely means "youngest" or refers to a branch. ÂçÅ‰∏ñÁ•ñ is "10th-generation ancestor." Â¥áË≥¢ÂÖ¨ is his name with the honorific ÂÖ¨.' },
            { section: 'ancestry', chars: 'ÊäÑ‰∏ÄÊóè‰πãÂ§ßÁï•', translation: 'copied down a general outline of the clan', notes: 'ÊäÑ means to copy or transcribe. Â§ßÁï• means "general outline" or "summary." This was the first attempt to record the family history.' },
            { section: 'ancestry', chars: 'ÊúÉÁπ™', translation: 'and compiled illustrations', notes: 'ÊúÉ can mean "to compile" or "to gather." Áπ™ means to draw or illustrate. Early genealogies often included portraits of ancestors or diagrams of family relationships.' },

            // ANCESTRY - Column 2
            { section: 'ancestry', chars: 'Ë≠úÁ®ø', translation: 'The genealogy draft', notes: 'Ë≠úÁ®ø combines Ë≠ú (genealogy) and Á®ø (draft/manuscript). This refers to the preliminary handwritten version.' },
            { section: 'ancestry', chars: 'Ëá≥ÈÅìÂÖâÈñì', translation: 'By the Daoguang period', notes: 'Ëá≥ means "until" or "by the time of." ÈÅìÂÖâ was Emperor Daoguang (r. 1820-1850). Èñì indicates "during" or "period."' },
            { section: 'ancestry', chars: 'ÂÖ∂Â≠´ÊúùË¶≤ÂÖ¨', translation: 'his grandson, the honorable Chaojin', notes: 'ÂÖ∂Â≠´ means "his grandson." ÊúùË¶≤ (Ch√°oj√¨n) is the grandson\'s name, meaning "court audience" - suggesting official connections. ÂÖ¨ is an honorific.' },
            { section: 'ancestry', chars: 'Âõ†Ë¶ãÁ•ñÈÅ∫ËàäÁ®ø', translation: 'upon seeing the old manuscript left by his grandfather', notes: 'Âõ† means "because" or "upon." Á•ñÈÅ∫ means "left by ancestor." ËàäÁ®ø is "old manuscript." This explains how the project was revived.' },
            { section: 'ancestry', chars: 'ÊúâÂøóÁ∫å‰øÆ', translation: 'was inspired to continue the compilation', notes: 'ÊúâÂøó means "had the aspiration/determination." Á∫å‰øÆ means "to continue compiling/editing." A common phrase in genealogical prefaces.' },
            { section: 'ancestry', chars: 'ÈÅÇÂçöÊé°ÂæßË®™', translation: 'and so he widely gathered [information] and visited extensively', notes: 'ÈÅÇ means "thereupon." ÂçöÊé° means "to gather widely." ÂæßË®™ (also written ÈÅçË®™) means "to visit everywhere" - conducting research among clan members.' },
            { section: 'ancestry', chars: 'Ëá™Êò≠ÂÖÉ', translation: 'from [ancestor] Zhaoyuan...', notes: 'Ëá™ means "from." Êò≠ÂÖÉ appears to be an ancestor\'s name, likely the earliest recorded progenitor of this branch. The text continues describing the scope of research.' }
        ];

        const characterData = {
            'Êïò': { pinyin: 'x√π', meaning: 'Preface; to narrate', context: 'Document title - a preface explaining the genealogy.' },
            'Âãæ': { pinyin: 'g≈çu', meaning: 'Hook; place name element', context: 'Part of Gouyu (ÂãæÁî¨), ancient name for Ningbo region.' },
            'Áî¨': { pinyin: 'y«íng', meaning: 'Ningbo; ancient place name', context: 'Part of Gouyu; also the modern abbreviation for Ningbo.' },
            'ÈÆë': { pinyin: 'b√†o', meaning: 'Surname Bao; salted fish', context: 'The clan surname, prominent in the Ningbo area.' },
            'Ê∞è': { pinyin: 'sh√¨', meaning: 'Clan, family', context: 'Suffix used after surnames in formal contexts.' },
            '‰πã': { pinyin: 'zhƒ´', meaning: 'Of, possessive particle', context: 'Classical Chinese possessive, like modern ÁöÑ.' },
            'Êúâ': { pinyin: 'y«íu', meaning: 'To have, there is', context: 'Indicates possession or existence.' },
            'Ë≠ú': { pinyin: 'p«î', meaning: 'Genealogy, register', context: 'A formal clan genealogy recording lineages.' },
            'Âßã': { pinyin: 'sh«ê', meaning: 'To begin, start', context: 'Marks the origin point of the genealogy.' },
            'Êñº': { pinyin: 'y√∫', meaning: 'At, in, from', context: 'Classical preposition for time/place.' },
            'Ââç': { pinyin: 'qi√°n', meaning: 'Before, former', context: 'ÂâçÊ∏Ö = former Qing (written after 1911).' },
            'Ê∏Ö': { pinyin: 'qƒ´ng', meaning: 'Qing dynasty; clear', context: 'The last imperial dynasty (1644-1911).' },
            '‰πæ': { pinyin: 'qi√°n', meaning: 'Heaven; Qianlong', context: 'Part of Emperor Qianlong\'s reign name.' },
            'ÈöÜ': { pinyin: 'l√≥ng', meaning: 'Prosperous, grand', context: '‰πæÈöÜ = Qianlong Emperor (r. 1735-1796).' },
            'Âπ¥': { pinyin: 'ni√°n', meaning: 'Year', context: 'Time period marker.' },
            'Â≠£': { pinyin: 'j√¨', meaning: 'Season; youngest', context: 'May indicate a branch or birth order.' },
            'ÂçÅ': { pinyin: 'sh√≠', meaning: 'Ten', context: 'ÂçÅ‰∏ñ = tenth generation.' },
            '‰∏ñ': { pinyin: 'sh√¨', meaning: 'Generation; world', context: 'Counts generations from founder.' },
            'Á•ñ': { pinyin: 'z«î', meaning: 'Ancestor, grandfather', context: '‰∏ñÁ•ñ = generational ancestor.' },
            'Â¥á': { pinyin: 'ch√≥ng', meaning: 'Lofty, to esteem', context: 'Part of ancestor\'s name Chongxian.' },
            'Ë≥¢': { pinyin: 'xi√°n', meaning: 'Worthy, virtuous', context: 'Â¥áË≥¢ = "Esteeming the Worthy."' },
            'ÂÖ¨': { pinyin: 'g≈çng', meaning: 'Honorific: sir, lord', context: 'Respectful suffix for male ancestors.' },
            'ÊäÑ': { pinyin: 'chƒÅo', meaning: 'To copy, transcribe', context: 'The initial recording was handwritten.' },
            '‰∏Ä': { pinyin: 'yƒ´', meaning: 'One, a', context: 'Emphasizes unity of the clan.' },
            'Êóè': { pinyin: 'z√∫', meaning: 'Clan, tribe', context: 'Extended family group sharing a surname.' },
            'Â§ß': { pinyin: 'd√†', meaning: 'Great, large', context: 'Part of Â§ßÁï• (general outline).' },
            'Áï•': { pinyin: 'l√º√®', meaning: 'Brief, outline', context: 'Â§ßÁï• = general summary.' },
            'ÊúÉ': { pinyin: 'hu√¨', meaning: 'To gather, compile', context: 'Assembling information together.' },
            'Áπ™': { pinyin: 'hu√¨', meaning: 'To draw, illustrate', context: 'Genealogies often included diagrams.' },
            'Á®ø': { pinyin: 'g«éo', meaning: 'Draft, manuscript', context: 'Ë≠úÁ®ø = genealogy manuscript.' },
            'Ëá≥': { pinyin: 'zh√¨', meaning: 'To reach, until', context: 'Indicates passage of time.' },
            'ÈÅì': { pinyin: 'd√†o', meaning: 'Way; Daoguang', context: 'Part of Emperor Daoguang\'s reign name.' },
            'ÂÖâ': { pinyin: 'guƒÅng', meaning: 'Light, glory', context: 'ÈÅìÂÖâ = Daoguang Emperor (r. 1820-1850).' },
            'Èñì': { pinyin: 'jiƒÅn', meaning: 'Between, during', context: 'Indicates a time period.' },
            'ÂÖ∂': { pinyin: 'q√≠', meaning: 'His, its', context: 'Pronoun referring to Chongxian.' },
            'Â≠´': { pinyin: 's≈´n', meaning: 'Grandson', context: 'The next compiler was a grandson.' },
            'Êúù': { pinyin: 'ch√°o', meaning: 'Court, dynasty', context: 'Part of name ÊúùË¶≤ (Chaojin).' },
            'Ë¶≤': { pinyin: 'j√¨n', meaning: 'To have audience with', context: 'ÊúùË¶≤ = imperial audience.' },
            'Âõ†': { pinyin: 'yƒ´n', meaning: 'Because, upon', context: 'Explains the motivation.' },
            'Ë¶ã': { pinyin: 'ji√†n', meaning: 'To see', context: 'Seeing the old manuscript inspired him.' },
            'ÈÅ∫': { pinyin: 'y√≠', meaning: 'To leave behind', context: 'Á•ñÈÅ∫ = left by ancestor.' },
            'Ëàä': { pinyin: 'ji√π', meaning: 'Old, former', context: 'ËàäÁ®ø = old manuscript.' },
            'Âøó': { pinyin: 'zh√¨', meaning: 'Will, aspiration', context: 'ÊúâÂøó = had the determination.' },
            'Á∫å': { pinyin: 'x√π', meaning: 'To continue', context: 'Á∫å‰øÆ = continue compiling.' },
            '‰øÆ': { pinyin: 'xi≈´', meaning: 'To compile, repair', context: 'Standard term for editing genealogies.' },
            'ÈÅÇ': { pinyin: 'su√¨', meaning: 'Thereupon, then', context: 'Indicates sequence of events.' },
            'Âçö': { pinyin: 'b√≥', meaning: 'Wide, extensive', context: 'ÂçöÊé° = gather widely.' },
            'Êé°': { pinyin: 'c«éi', meaning: 'To gather, collect', context: 'Collecting information.' },
            'Âæß': { pinyin: 'bi√†n', meaning: 'Everywhere (=ÈÅç)', context: 'ÂæßË®™ = visit extensively.' },
            'Ë®™': { pinyin: 'f«éng', meaning: 'To visit, inquire', context: 'Researching among clan members.' },
            'Ëá™': { pinyin: 'z√¨', meaning: 'From, since', context: 'Starting point of the research.' },
            'Êò≠': { pinyin: 'zhƒÅo', meaning: 'Bright, clear', context: 'Part of ancestor name Êò≠ÂÖÉ.' },
            'ÂÖÉ': { pinyin: 'yu√°n', meaning: 'First, origin', context: 'Êò≠ÂÖÉ = earliest recorded ancestor.' }
        };

        const textLayout = [
            { type: 'title', section: 'title', chars: 'Êïò', x: 667, y: 64, size: 14, spacing: 1.14 },
            { type: 'text', section: 'ancestry', chars: 'ÂãæÁî¨ÈÆëÊ∞è‰πãÊúâË≠úÂßãÊñºÂâçÊ∏Ö‰πæÈöÜÂπ¥Â≠£ÂçÅ‰∏ñÁ•ñÂ¥áË≥¢ÂÖ¨ÊäÑ‰∏ÄÊóè‰πãÂ§ßÁï•ÊúÉÁπ™', x: 643, y: 67, size: 14, spacing: 1.06 },
            { type: 'text', section: 'ancestry', chars: 'Ë≠úÁ®øËá≥ÈÅìÂÖâÈñìÂÖ∂Â≠´ÊúùË¶≤ÂÖ¨Âõ†Ë¶ãÁ•ñÈÅ∫ËàäÁ®øÊúâÂøóÁ∫å‰øÆÈÅÇÂçöÊé°ÂæßË®™Ëá™Êò≠ÂÖÉ', x: 618, y: 67, size: 14, spacing: 1.06 }
        ];

        // ========== STATE ==========
        let isLocked = false;
        let currentCharEl = null;

        // ========== RENDERING ==========
        function renderDocument() {
            const container = document.getElementById('document');
            container.innerHTML = '';

            textLayout.forEach((column, colIndex) => {
                const colDiv = document.createElement('div');
                colDiv.className = 'column' + (column.type === 'title' ? ' title-column' : '');
                colDiv.dataset.colIndex = colIndex;
                colDiv.dataset.section = column.section;
                colDiv.style.left = column.x + 'px';
                colDiv.style.top = column.y + 'px';

                for (let i = 0; i < column.chars.length; i++) {
                    const char = column.chars[i];
                    const charSpan = document.createElement('span');
                    charSpan.className = 'char';
                    charSpan.textContent = char;
                    charSpan.dataset.char = char;
                    charSpan.dataset.colIndex = colIndex;
                    charSpan.dataset.charIndex = i;
                    charSpan.dataset.section = column.section;

                    if (column.size) {
                        charSpan.style.fontSize = column.size + 'px';
                    }
                    if (column.spacing) {
                        charSpan.style.lineHeight = column.spacing;
                    }

                    charSpan.addEventListener('mouseenter', handleCharHover);
                    charSpan.addEventListener('click', handleCharClick);
                    colDiv.appendChild(charSpan);
                }

                container.appendChild(colDiv);
            });
        }

        // ========== EVENT HANDLERS ==========
        function handleCharHover(event) {
            if (isLocked) return;
            updateDisplay(event.target);
        }

        function handleCharClick(event) {
            event.stopPropagation();
            const charEl = event.target;

            if (isLocked) {
                unlock();
            } else {
                isLocked = true;
                charEl.classList.add('locked');
                currentCharEl = charEl;
                document.getElementById('lockIcon').style.display = 'block';
                updateDisplay(charEl);
            }
        }

        function unlock() {
            isLocked = false;
            if (currentCharEl) {
                currentCharEl.classList.remove('locked');
            }
            document.getElementById('lockIcon').style.display = 'none';
            currentCharEl = null;
        }

        document.getElementById('lockIcon').addEventListener('click', unlock);
        document.getElementById('documentContainer').addEventListener('click', (e) => {
            if (e.target === document.getElementById('documentContainer') ||
                e.target === document.getElementById('originalImage')) {
                unlock();
            }
        });

        // Find phrase that may span multiple columns, returns {phrase, segments}
        function findPhraseForChar(colIndex, charIndex) {
            const column = textLayout[colIndex];

            // First, try to find phrase entirely within this column
            for (const p of phrases) {
                const phraseStart = column.chars.indexOf(p.chars);
                if (phraseStart !== -1 && charIndex >= phraseStart && charIndex < phraseStart + p.chars.length) {
                    return { phrase: p, segments: [{ colIndex, startIdx: phraseStart, length: p.chars.length }] };
                }
            }

            // Check for phrases spanning from previous column into this one
            if (colIndex > 0) {
                const prevCol = textLayout[colIndex - 1];
                for (const p of phrases) {
                    for (let splitPoint = 1; splitPoint < p.chars.length; splitPoint++) {
                        const firstPart = p.chars.substring(0, splitPoint);
                        const secondPart = p.chars.substring(splitPoint);
                        if (prevCol.chars.endsWith(firstPart) && column.chars.startsWith(secondPart)) {
                            const prevStartIdx = prevCol.chars.length - firstPart.length;
                            if (charIndex < secondPart.length) {
                                return {
                                    phrase: p,
                                    segments: [
                                        { colIndex: colIndex - 1, startIdx: prevStartIdx, length: firstPart.length },
                                        { colIndex: colIndex, startIdx: 0, length: secondPart.length }
                                    ]
                                };
                            }
                        }
                    }
                }
            }

            // Check for phrases spanning from this column into next one
            if (colIndex < textLayout.length - 1) {
                const nextCol = textLayout[colIndex + 1];
                for (const p of phrases) {
                    for (let splitPoint = 1; splitPoint < p.chars.length; splitPoint++) {
                        const firstPart = p.chars.substring(0, splitPoint);
                        const secondPart = p.chars.substring(splitPoint);
                        if (column.chars.endsWith(firstPart) && nextCol.chars.startsWith(secondPart)) {
                            const startIdx = column.chars.length - firstPart.length;
                            if (charIndex >= startIdx) {
                                return {
                                    phrase: p,
                                    segments: [
                                        { colIndex: colIndex, startIdx: startIdx, length: firstPart.length },
                                        { colIndex: colIndex + 1, startIdx: 0, length: secondPart.length }
                                    ]
                                };
                            }
                        }
                    }
                }
            }

            // Fallback: find any phrase containing this character
            for (const p of phrases) {
                if (p.chars.includes(column.chars[charIndex])) {
                    return { phrase: p, segments: [] };
                }
            }

            return { phrase: null, segments: [] };
        }

        // ========== DISPLAY UPDATE ==========
        function updateDisplay(charEl) {
            const char = charEl.dataset.char;
            const colIndex = parseInt(charEl.dataset.colIndex);
            const charIndex = parseInt(charEl.dataset.charIndex);
            const sectionId = charEl.dataset.section;

            // Clear all highlights
            document.querySelectorAll('.char').forEach(el => el.classList.remove('char-highlight'));
            document.querySelectorAll('.phrase-highlight-box').forEach(el => el.remove());
            document.querySelectorAll('.section-highlight-box').forEach(el => el.remove());

            // Highlight current character (RED)
            charEl.classList.add('char-highlight');

            // Find and highlight phrase (BLUE)
            const { phrase: foundPhrase, segments } = findPhraseForChar(colIndex, charIndex);
            for (const seg of segments) {
                drawPhraseHighlight(seg.colIndex, seg.startIdx, seg.length);
            }

            // Highlight section (GREEN)
            const section = sections[sectionId];
            drawSectionHighlight(sectionId);

            // Update info panel
            updateInfoPanel(char, foundPhrase, section);
        }

        function drawPhraseHighlight(colIndex, startIdx, length) {
            const colEl = document.querySelector(`[data-col-index="${colIndex}"]`);
            if (!colEl) return;

            const chars = colEl.querySelectorAll('.char');
            if (startIdx >= chars.length) return;

            const firstChar = chars[startIdx];
            const lastChar = chars[Math.min(startIdx + length - 1, chars.length - 1)];

            const colRect = colEl.getBoundingClientRect();
            const firstRect = firstChar.getBoundingClientRect();
            const lastRect = lastChar.getBoundingClientRect();

            const container = document.getElementById('documentContainer');
            const scale = container.offsetWidth / BASE_SIZE;

            const margin = 4;
            const box = document.createElement('div');
            box.className = 'phrase-highlight-box';
            box.style.top = ((firstRect.top - colRect.top) / scale - margin) + 'px';
            box.style.left = ((firstRect.left - colRect.left) / scale - margin) + 'px';
            box.style.width = (Math.max(firstRect.width, lastRect.width) / scale + margin * 2) + 'px';
            box.style.height = ((lastRect.bottom - firstRect.top) / scale + margin * 2) + 'px';

            colEl.appendChild(box);
        }

        function drawSectionHighlight(sectionId) {
            const sectionColumns = document.querySelectorAll(`.column[data-section="${sectionId}"]`);
            if (sectionColumns.length === 0) return;

            const documentEl = document.getElementById('document');
            const docRect = documentEl.getBoundingClientRect();

            const container = document.getElementById('documentContainer');
            const scale = container.offsetWidth / BASE_SIZE;

            const colData = [];
            sectionColumns.forEach(col => {
                const rect = col.getBoundingClientRect();
                colData.push({ el: col, rect: rect });
            });

            colData.sort((a, b) => b.rect.left - a.rect.left);

            const groups = [];
            let currentGroup = [colData[0]];

            for (let i = 1; i < colData.length; i++) {
                const prev = currentGroup[currentGroup.length - 1];
                const curr = colData[i];
                const gap = prev.rect.left - curr.rect.right;
                if (gap < 50 * scale) {
                    currentGroup.push(curr);
                } else {
                    groups.push(currentGroup);
                    currentGroup = [curr];
                }
            }
            groups.push(currentGroup);

            groups.forEach(group => {
                let minLeft = Infinity, minTop = Infinity;
                let maxRight = -Infinity, maxBottom = -Infinity;

                group.forEach(({ rect }) => {
                    minLeft = Math.min(minLeft, rect.left);
                    minTop = Math.min(minTop, rect.top);
                    maxRight = Math.max(maxRight, rect.right);
                    maxBottom = Math.max(maxBottom, rect.bottom);
                });

                const margin = 8;
                const box = document.createElement('div');
                box.className = 'section-highlight-box';
                box.style.left = ((minLeft - docRect.left) / scale - margin) + 'px';
                box.style.top = ((minTop - docRect.top) / scale - margin) + 'px';
                box.style.width = ((maxRight - minLeft) / scale + margin * 2) + 'px';
                box.style.height = ((maxBottom - minTop) / scale + margin * 2) + 'px';

                documentEl.appendChild(box);
            });
        }

        function updateInfoPanel(char, phrase, section) {
            const charData = characterData[char];
            document.getElementById('charDisplay').textContent = char;

            if (charData) {
                document.getElementById('pinyin').textContent = charData.pinyin;
                document.getElementById('charMeaning').textContent = charData.meaning;
                document.getElementById('charContext').textContent = charData.context;
            } else {
                document.getElementById('pinyin').textContent = '‚Äî';
                document.getElementById('charMeaning').textContent = 'Character not yet documented.';
                document.getElementById('charContext').textContent = '';
            }

            if (phrase) {
                document.getElementById('phraseChinese').textContent = phrase.chars;
                document.getElementById('phraseTranslation').textContent = '"' + phrase.translation + '"';
                document.getElementById('phraseNotes').textContent = phrase.notes;
            } else {
                document.getElementById('phraseChinese').textContent = char;
                document.getElementById('phraseTranslation').textContent = '(Single character)';
                document.getElementById('phraseNotes').textContent = 'Part of a phrase not yet documented.';
            }

            if (section) {
                document.getElementById('sectionTitle').textContent = section.name;
                document.getElementById('sectionChinese').textContent = section.chinese;
                document.getElementById('sectionDesc').textContent = section.description;
            }
        }

        // ========== OPACITY ==========
        function updateOpacity(value) {
            const v = value / 100;
            document.getElementById('originalImage').style.opacity = 1 - v;
            document.documentElement.style.setProperty('--text-opacity', v);
            document.documentElement.style.setProperty('--text-bg-opacity', v);
        }

        // ========== SCALING ==========
        const BASE_SIZE = 700; // Base container size that positions were calibrated for

        function updateScale() {
            const container = document.getElementById('documentContainer');
            const doc = document.getElementById('document');
            const actualSize = container.offsetWidth;
            const scale = actualSize / BASE_SIZE;
            doc.style.transform = `scale(${scale})`;
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            renderDocument();
            updateScale();

            const slider = document.getElementById('overlaySlider');
            slider.addEventListener('input', (e) => updateOpacity(e.target.value));
            updateOpacity(slider.value);

            // Set initial display to first character
            const firstChar = document.querySelector('.char');
            if (firstChar) {
                updateDisplay(firstChar);
            }

            // Update scale on window resize
            window.addEventListener('resize', updateScale);
        });
    </script>
</body>
</html>
